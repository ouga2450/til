---
tags:
  - 日記
  - PermanentNote
aliases: 
UID: 2025-08-09T12-54-54
---
[4_RSpecの修正](4_RSpecの修正.md)
[日記](日記.md)

# RSpecの修正
与えられた課題を修正してRSpecが実行できるようにする

## letにFactoryBotの処理をまとめる
let(:project) { FactoryBot.create(:project) }
let(:task) { FactoryBot.create(:task, project_id: project.id) }

contextごとに記述する必要がなくなるので楽になる
また、テストが読みやすくなる

visitでサイトアクセスした際に受けとる値をprojectからtask.projectに書き換える

これはletが遅延実行となるため、task.projectとしてprojectと同時にtaskを実行してあげないと、タスク一覧などのページ表示が上手くいかないためである

it '一覧ページにアクセスした場合、Taskが表示されること' do
        visit project_tasks_path(task.project)
        expect(find('.task_list')).to have_content task.title
        expect(Task.count).to eq 1
        expect(current_path).to eq project_tasks_path(task.project)
      end

## 処理の途中で別ウィンドウで開かれる場合
capybaraは現在のウィンドウの処理しか追えないため、別ウィンドウの処理を追跡するために以下の記述が必要となる
```
switch_to_window(windows.last)
```

## アプリケーションヘルパーを使用する場合

今回は画面上の時間表示とcapybaraのテストを合わせるためにshort_time(Time.current)を使用
その場合short_timeはapplicationHelperとなるため、rails_helper.rbに記載が必要となる
```
config.include ApplicationHelper
```

## traitを使用する
### traitとは
factory bot内で継承し、一部ステータスの異なるファクトリデータを作成するときに使用する
例えばtaskの記述内にstatus: doneとなっている（statusだけ異なる）traitを記述しておくと、ファクトリデータを作成する際に楽な記述で実装することができる
traitの記述例
```
# spec/factories/tasks.rb
FactoryBot.define do 
	factory :task do 
		title { 'Task' } 
		status { :todo } 
		from = Date.parse("2019/08/01") 
		to = Date.parse("2019/12/31") 
		deadline { Random.rand(from..to) } 
		association :project
		
		trait :done do 
			status { :done } 
			completion_date { Time.current.yesterday } 
		end
	end 
end
```
traitによる記述量の比較
trait使用
```
let(:task_done) { create(:task, :done) }
```
trait不使用
```
{ create(:task, status: :done, completion_date: Time.current.yesterday) }
```

## alert処理
### JavaScriptのアラートを処理する記述

```
page.driver.browser.switch_to.alert.accept
```
各部分の役割
- page - capybaraの現在のページオブジェクト
- driver - capybaraが使用しているドライバー
- browser - 実際のブラウザインスタンス
- switch_to.alert - JavaScriptのアラートダイアログに切り替え
- accept - アラートの「OK」ボタンをクリック

## have_contentの対象スコープについて
```
      # FIXME: テストが失敗するので修正してください
      it 'Taskが削除されること' do
        visit project_tasks_path(task.project, task)
        within('.task_list') do
          expect(page).to have_content(task.title)
        end
        click_link 'Destroy'
        page.driver.browser.switch_to.alert.accept
        expect(page).not_to have_content task.title
        expect(Task.count).to eq 0
        expect(current_path).to eq  project_tasks_path(task.project)
      end
```
実行時のエラー
```
Failure/Error: expect(page).not_to have_content task.title
       expected not to find text "Task" in "Exam01Bugfix Task was successfully destroyed. Tasks of a Title Status Deadline New Task"
```
task.title = 'Task'であるのでページ内の'Task was successfully destroyed.'
にTaskが含まれているためエラーに
今回task.titleが含めれていないことを確認したい理由はtaskの削除が成功しているかどうか確認するためなので、確認対象をページ全体からタスクリストに限定（スコープ）させる必要がある

よって以下のように書き換える
```
      # FIXME: テストが失敗するので修正してください
      it 'Taskが削除されること' do
        visit project_tasks_path(task.project, task)
        within('.task_list') do
          expect(page).to have_content(task.title)
        end
        click_link 'Destroy'
        page.driver.browser.switch_to.alert.accept
        within('.task_list')
          expect(page).not_to have_content task.title
        end
        expect(Task.count).to eq 0
        expect(current_path).to eq  project_tasks_path(task.project)
      end
```
task_listの頭に'.'をつける理由
'.'なしだと・・・htmlを対象とする
'.'ありだと・・・CSSを対象とする
今回はCSSの記述のためドットをつける必要がある

## rails基礎復習
### shallow
ネストしたリソースのルーティングを浅くする
親リソースが必要なアクションを除いてURLに親リソースを含まないようにしてくれる
例
- shallowオプションを使っていない場合
    
    - コメントの作成: /boards/:board_id/comments
    - コメントの編集: /boards/:board_id/comments/:id/edit
    - コメントの削除: /boards/:board_id/comments/:id
    - コメントの表示: /boards/:board_id/comments/:id
- shallowオプションを使った場合
    
    - コメントの作成: /boards/:board_id/comments
    - コメントの編集: /comments/:id/edit
    - コメントの削除: /comments/:id
    - コメントの表示: /comments/:id