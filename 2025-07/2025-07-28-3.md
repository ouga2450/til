---
tags:
  - PermanentNote
  - 日記
aliases: 
UID: 2025-07-28T16-11-04
---
[日記](日記.md)
[18_掲示板の検索機能を実装](18_掲示板の検索機能を実装.md)
[Ruby on Rails 基礎](Ruby%20on%20Rails%20基礎.md)

# 検索機能の実装
## インプットフェーズ
### 概要
- 掲示板のタイトル or 本文の部分一致検索ができること。
- 掲示板一覧画面で検索を実行する際は /boards にリクエストを飛ばすこと。
- ブックマーク一覧画面で検索を実行する際は /boards/bookmarks にリクエストを飛ばすこと。
- ブックマーク一覧画面で検索した場合は、ログインしているユーザーがブックマークした掲示板から検索が行われること。

### 検索プロセス
検索キーワードの入力：ユーザーが検索ボックスにキーワードを入力
検索クエリの生成：アプリケーションはユーザーが入力したキーワードをもとに検索クエリを生成　クエリはデータベースに対して発行され、特定の条件にマッチするレコードを探す
検索の実行：検索クエリがデータベースに対して実行され、結果が返される
結果の表示：アプリケーションは検索結果をユーザーに表示

### 部分一致検索
これを実現するにはSQLのLIKE演算子を使用する
例えば、%キーワード%という形で検索クエリを作成すると、指定されたキーワードを含むすべてのレコードが検索される

### gem 'ransack'
検索フォームの作成から検索クエリの生成、検索結果の表示までを包括的にサポート

主な機能は以下の通り
- 検索フォームの生成 ： ransackは、簡単に検索フォームを生成するためのヘルパーメソッドを提供します。
- 柔軟な検索条件 ： 部分一致検索、完全一致検索、範囲検索など、さまざまな検索条件をサポートします。
- ソート機能 ： 検索結果を特定のカラムでソートする機能も提供します。
- シンプルな構文 ： ransackはシンプルなRuby構文を使用しているため、既存のコードに容易に統合できます。

### result(distinct: true)
gem 'ransack'に存在するメソッドで、検索結果を重複のないユニークなレコードに限定するためのオプション
このメソッドを使用することで、検索結果に同じレコードが複数回表示されるのを防ぐことができる
データベースにおいて、特定の条件に一致するレコードが複数存在する場合、通常の検索ではこれらのレコードがすべて表示される
しかし、ユーザーが求めているのは一意の結果であることが多いため、distinct: trueオプションを使用することで、重複するレコードを除外し、一意のレコードのみを取得する

このオプションの利点
- 結果の明確化 ： 重複するレコードが除外されるため、検索結果がより明確で理解しやすくなります。
- パフォーマンスの向上 ： 不必要な重複データを処理する必要がなくなるため、検索パフォーマンスが向上します。
- データの整合性 ： 一意のレコードのみを表示することで、データの整合性が保たれます。

例えば、ある掲示板アプリケーションで、特定のキーワードを含む投稿を検索する際に、distinct: true を使用することで、同じ投稿が複数回表示されるのを防ぎ、ユーザーにとってわかりやすい検索結果を提供できます。

## 実装方法
### gem 'ransack'導入
### config/locales/views/ja.ymlを編集
検索フォーム関係の記述をdefaultsに追記
### コントローラーの編集app/controllers/boards_controller.rb
indexとbookmarksを編集する
```
  def index
    @q = Board.ransack(params[:q])
    @boards = @q.result(distinct: true).includes(:user).page(params[:page])
  end

  def bookmarks
    @q = current_user.bookmark_boards.ransack(params[:q])
    @bookmark_boards = @q.result(distinct: true).includes(:user).order(created_at: :desc).page(params[:page])
  end
```

@qがransackのデフォルトの変数
ここに検索したいモデルの情報を格納する
元々記述されていた一覧表示用のインスタンス変数に @q.result(distinct: true) を記述する
（テーブルから情報を取得する記述は@qにすでに記述されているため、削除する）
これにより一覧表示する際にSQLによってフィルターされた結果が格納される

### 検索フォームの部分テンプレートを作成
```
<%= search_form_for q, url: url do |f| %>
  <div class="input-group mb-3">
    <%= f.search_field :title_or_body_cont, class: 'form-control', placeholder: t('defaults.search_word') %>
    <div class="input-group-append">
      <%= f.submit class: 'btn btn-primary' %>
    </div>
  </div>
<% end %>
```
search_fieldには何が入る？
検索したいカラムを記述する→今回はタイトルと本文なのでtitle_body
contは部分検索を示している

### 部分テンプレートをビューに挿入

